<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./style.css?v=11">
  <title>裝備清單｜第二十三號</title>

  <link rel="icon" href="./assets/icons/favicon-v2.ico" sizes="any">
  <link rel="apple-touch-icon" href="./assets/icons/apple-touch-icon.png" sizes="180x180">

  <style>
    /* 配合 KPA 觀察日誌風格的 Gear 頁面微調 */
    :root {
      --label-color: #ccc;
      --border-light: #f2f2f2;
    }

    .gear-controls {
      display: flex;
      gap: 15px;
      margin: 20px 0 30px;
      border-bottom: 1px solid var(--border-light);
      padding-bottom: 15px;
    }
    .btn-mini {
      background: none;
      border: none;
      padding: 0;
      font-size: 0.75rem;
      color: #888;
      cursor: pointer;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }
    .btn-mini:hover { color: #111; }

    #summaryBox {
      background: none;
      border: none;
      padding: 0;
      margin-bottom: 40px;
    }
    #summaryBox .data-row {
      border-bottom: 1px solid var(--border-light);
      padding: 12px 0;
      font-size: 0.95rem;
    }
    #summaryBox .num {
      font-family: "Helvetica Neue", Arial, sans-serif;
      color: #111;
    }

    details.gear-section { margin-bottom: 10px; }
    details.gear-section > summary {
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 0;
      font-size: 0.85rem;
      color: var(--label-color);
      letter-spacing: 0.1em;
      list-style: none;
    }
    details.gear-section > summary::-webkit-details-marker { display: none; }
    details.gear-section > summary strong { color: #555; font-weight: 500; }

    .gear-cat {
      border: none;
      background: none;
      padding: 0;
      margin-bottom: 30px;
    }

    .gear-item {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      padding: 8px 0;
      border-bottom: 1px solid var(--border-light);
    }

    .gear-name {
      font-size: 0.95rem;
      color: #111;
      line-height: 1.3;
      margin-bottom: 1px;
    }

    .small {
      font-size: 0.75rem;
      color: #aaa;
      line-height: 1.3;
      margin-top: 1px;
      display: block;
    }

    .gear-right {
      display: flex;
      gap: 8px;
      align-items: center;
      padding-top: 2px;
    }

    .gear-right .t {
      border: none;
      background: #f9f9f9;
      font-size: 0.7rem;
      color: #999;
      padding: 4px 6px;
      border-radius: 4px;
      cursor: pointer;
      appearance: none;
    }
    .gear-right .w {
      width: 65px;
      border: none;
      border-bottom: 1px solid #eee;
      padding: 4px 0;
      font-size: 0.9rem;
      text-align: right;
      font-family: "Helvetica Neue", monospace;
      color: #333;
      outline: none;
    }
    .gear-right .w:focus { border-bottom-color: #111; }

    .is-hidden { display: none !important; }

    .gear-item.is-empty .gear-name { color: #999; }
    .gear-item.is-empty .small { color: #bbb; }
    .gear-item.is-empty .w { border-bottom-color: #ddd; color: #aaa; }

    .gear-warn {
      font-size: 0.85rem;
      color: #bbb;
      margin-left: 6px;
      user-select: none;
    }
  </style>
</head>

<body id="top" class="narrow">
  <div id="nav-placeholder"></div>

  <main>
    <h1>裝備清單</h1>
    <div class="muted">GEAR LOGISTICS</div>

    <div class="box" id="summaryBox">
      <div class="data-row"><div>Base weight</div><div class="num"><strong id="baseW">—</strong> g</div></div>
      <div class="data-row"><div>Worn</div><div class="num"><strong id="wornW">—</strong> g</div></div>
      <div class="data-row"><div>Consumable</div><div class="num"><strong id="consW">—</strong> g</div></div>
      <div class="data-row"><div>Total</div><div class="num"><strong id="totalW">—</strong> g</div></div>
      <p class="small" style="margin-top:10px;">註：目前仍在變動中，之後應該也會隨著行程更新配置。</p>
    </div>

    <div class="gear-controls">
      <button type="button" class="btn-mini" id="expandAll">全部展開</button>
      <button type="button" class="btn-mini" id="collapseAll">全部收合</button>
      <button type="button" class="btn-mini" id="exportCSV">CSV 匯出</button>
    </div>

    <!-- ✅ 以下保持你的原內容不動（你貼的那一大段 details... 全部留著） -->
    <!-- 你原本從 <details class="gear-section"...> 到結尾的內容，請照貼回來 -->
    <!-- ⚠️ 注意：你貼文中「衛生」那段開始有 <details> 沒關閉的疑慮，我下一步會一起修 nav 後順便幫你查這段 -->

    <!-- 你原內容開始 -->
    <!--（為了不在這裡重複貼到爆炸：你把你剛剛貼的 main 內所有 details 區塊原封不動貼進來即可）-->
    <!-- 你原內容結束 -->

    <p class="more"><a href="#top">↑ 回到頂部</a></p>
  </main>

  <!-- ✅ nav 注入：放在 body 最後，且等 DOM 有 #nav-placeholder 再塞 -->
<script>
document.addEventListener('DOMContentLoaded', () => {

  // 1) 載入 nav（失敗就安靜略過）
  fetch('./nav.html', { cache: 'no-store' })
    .then(res => {
      if(!res.ok) throw new Error('nav.html not found');
      return res.text();
    })
    .then(html => {
      const holder = document.getElementById('nav-placeholder');
      if (holder) holder.innerHTML = html;
    })
    .catch(() => { /* ignore */ });

  // 2) Gear functions
  function toNum(v){
    const n = Number(String(v ?? "").replace(/[^0-9.]/g, ""));
    return Number.isFinite(n) ? n : 0;
  }

  function markEmptyWeights(){
    document.querySelectorAll('.gear-item').forEach(row => {
      const wEl = row.querySelector('.w');
      if(!wEl) return;

      const raw = String(wEl.value ?? '').trim();
      const isEmpty = raw === '';

      row.classList.toggle('is-empty', isEmpty);

      const nameEl = row.querySelector('.gear-name');
      if(!nameEl) return;

      let warn = nameEl.querySelector('.gear-warn');
      if(isEmpty){
        if(!warn){
          warn = document.createElement('span');
          warn.className = 'gear-warn';
          warn.textContent = '⚠︎';
          warn.title = '重量未填';
          nameEl.appendChild(warn);
        }
      }else{
        if(warn) warn.remove();
      }
    });
  }

  function render(){
    let base=0, worn=0, cons=0, total=0;

    document.querySelectorAll('.gear-cat').forEach(catEl => {
      let catSum = 0;
      catEl.querySelectorAll('.gear-item').forEach(row => {
        const w = toNum(row.querySelector('.w')?.value);
        catSum += w;
      });
      const catId = catEl.getAttribute('data-cat');
      const out = document.querySelector('.cat-sum[data-cat="'+catId+'"]');
      if(out) out.textContent = Math.round(catSum);
    });

    document.querySelectorAll('.gear-item').forEach(row => {
      const w = toNum(row.querySelector('.w')?.value);
      const t = row.querySelector('.t')?.value || row.getAttribute('data-type') || 'base';

      total += w;
      if(t === 'worn') worn += w;
      else if(t === 'consumable') cons += w;
      else base += w;
    });

    const baseEl = document.getElementById('baseW');
    const wornEl = document.getElementById('wornW');
    const consEl = document.getElementById('consW');
    const totalEl = document.getElementById('totalW');

    if(baseEl) baseEl.textContent = Math.round(base);
    if(wornEl) wornEl.textContent = Math.round(worn);
    if(consEl) consEl.textContent = Math.round(cons);
    if(totalEl) totalEl.textContent = Math.round(total);

    markEmptyWeights();
  }

  // 3) 事件綁定（這裡一定在 DOM 出現後才會跑）
  document.addEventListener('input', (e) => {
    if(e.target && (e.target.matches('.w') || e.target.matches('.t'))) render();
  });

  document.getElementById('expandAll')?.addEventListener('click', () => {
    document.querySelectorAll('details.gear-section').forEach(d => d.open = true);
  });

  document.getElementById('collapseAll')?.addEventListener('click', () => {
    document.querySelectorAll('details.gear-section').forEach(d => d.open = false);
  });

  document.getElementById('exportCSV')?.addEventListener('click', () => {
    const rows = [];
    rows.push(['category','item','type','weight_g','note'].join(','));

    document.querySelectorAll('details.gear-section').forEach(section => {
      const cat = section.querySelector('summary span')?.textContent?.trim() || '';
      section.querySelectorAll('.gear-item').forEach(item => {
        const name = item.querySelector('.gear-name')?.textContent?.trim() || '';
        const type = item.querySelector('.t')?.value || 'base';
        const w = item.querySelector('.w')?.value || '';
        const note = item.querySelector('.small')?.textContent?.trim() || '';
        const safe = (s) => '"' + String(s).replaceAll('"','""') + '"';
        rows.push([safe(cat), safe(name), safe(type), safe(w), safe(note)].join(','));
      });
    });

    const csv = rows.join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'gear.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // 4) 初次計算
  render();
});
</script>
</body>
</html>
